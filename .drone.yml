---
kind: pipeline
name: Build NixOS & home-manager

steps:
- name: test
  image: busybox
  environment:
    NIX_REMOTE: daemon
    PATH: /nix/var/nix/profiles/system/sw/bin/
    PAGER: cat
    USER: root
    BUILDDIR: /var/lib/drone/nix-build
    CACHIX_SIGNING_KEY:
      from_secret: CACHIX_SIGNING_KEY
  volumes:
    - name: nixstore
      path: /nix
    - name: sslcerts
      path: /etc/ssl
    - name: gcroots
      path: /var/lib/drone/nix-build
  commands:
  - mkdir /etc/nix
  - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
  # TODO fix this NIX_PATH impurities in homemanager
  - export NIX_PATH=$(nix eval --raw --impure --expr '"nixpkgs=$${(builtins.getFlake (toString ./.)).inputs.nixpkgs}"')
  - rm -rf $BUILDDIR/gcroots.tmp && mkdir -p $BUILDDIR/gcroots.tmp
  - nix build -L --out-link $BUILDDIR/gcroots.tmp/result -f ./nixos/ci.nix
  - rm -rf $BUILDDIR/gcroots && mv $BUILDDIR/gcroots.tmp $BUILDDIR/gcroots
  - |
    if [[ -n "$CACHIX_SIGNING_KEY" ]]; then
      nix path-info --json -r $BUILDDIR/gcroots/result* > $BUILDDIR/path-info.json
      nix shell '.#jq' -c jq -r 'map(select(.ca == null and .signatures == null)) | map(.path) | .[]' < $BUILDDIR/path-info.json > paths
      nix shell '.#cachix' -c cachix push --jobs 32 mic92 < paths
    fi
volumes:
- name: nixstore
  host:
    path: /nix
- name: gcroots
  host:
    path: /var/lib/drone/nix-build
- name: sslcerts
  host:
    path: /nix/var/nix/profiles/system/etc/ssl
---
kind: signature
hmac: 42c6da64ba008c611518ba38b63e1f2754cdcb67917978edacd924c0f51812bd

...
